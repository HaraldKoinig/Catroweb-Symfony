function triggerFacebookLogin(){FB.login(function(response){response.authResponse?(console.log("Facebook Login successful"),checkLoginState()):console.log("User cancelled login or did not fully authorize.")},{scope:"public_profile,email",return_scopes:!0,auth_type:$("#facebook_auth_type").val()})}function checkLoginState(){FB.getLoginStatus(function(response){statusChangeCallback(response)})}function statusChangeCallback(response){"connected"===response.status?($("#access_token_oauth").val(response.authResponse.accessToken),getFacebookUserInfo()):"not_authorized"===response.status?document.getElementById("status").innerHTML="Please sign in to Pocket Code":document.getElementById("status").innerHTML="Please log into Facebook"}function getFacebookUserInfo(){console.log("Welcome!  Fetching your information.... "),FB.api("/me",function(response){$("#id_oauth").val(response.id),$("#email_oauth").val(response.email),$("#locale_oauth").val(response.locale),handleFacebookUserInfoResponseTrigger()})}$(document).ready(function(){$.ajaxSetup({cache:!0}),$.getScript("//connect.facebook.net/en_US/sdk.js",function(){var $appid="",$ajaxGetFBAppId=Routing.generate("catrobat_oauth_login_get_facebook_appid",{flavor:"pocketcode"});$.get($ajaxGetFBAppId,function(data){$appid=data.fb_appid,FB.init({appId:$appid,xfbml:!0,status:!0,cookie:!0,version:"v2.1"})})}),$("#logout").click(function(){FacebookLogout()}),$("#_submit_oauth").attr("disabled",!0),$(document).on("click","#btn-login_facebook",function(){agree_button="facebook_login"})});var handleFacebookUserInfoResponseTrigger=function(){$id=$("#id_oauth").val(),$email=$("#email_oauth").val(),$locale=$("#locale_oauth").val();var $ajaxUrlCheckServerTokenAvailable=Routing.generate("catrobat_oauth_login_facebook_servertoken_available",{flavor:"pocketcode"});$.post($ajaxUrlCheckServerTokenAvailable,{id:$id},function(data,status){if(console.log(status),data.token_available)FacebookLogin(data.email,data.username,$id,$locale);else{var $ajaxUrlCheckEmailAvailable=Routing.generate("catrobat_oauth_login_email_available",{flavor:"pocketcode"});$.post($ajaxUrlCheckEmailAvailable,{email:$email},function(data,status){console.log(status),0==data.email_available?getDesiredUsernameFB():sendTokenToServer($("#access_token_oauth").val(),$id,data.username,$email,$locale)})}})};function getDesiredUsernameFB(){$("#fb_google").val("fb"),openDialog()}function sendTokenToServer($token,$facebook_id,$username,$email,$locale){var $state=$("#csrf_token").val(),$ajaxUrl=Routing.generate("catrobat_oauth_login_facebook_token",{flavor:"pocketcode"});$.post($ajaxUrl,{client_token:$token,id:$facebook_id,state:$state,username:$username,email:$email,locale:$locale},function(data,status){console.log(status),FacebookLogin($email,$username,$facebook_id,$locale)})}function FacebookLogin($email,$username,$id,$locale){var $ajaxUrl=Routing.generate("catrobat_oauth_login_facebook",{flavor:"pocketcode"});$.post($ajaxUrl,{username:$username,id:$id,email:$email,locale:$locale},function(data,status){var $ajaxLoginRedirectUrl=Routing.generate("catrobat_oauth_login_redirect",{flavor:"pocketcode"});$.post($ajaxLoginRedirectUrl,{fb_id:$id},function(data,status){$url=data.url,$(location).attr("href",$url)})})}function FacebookLogout(){FB.getLoginStatus(function(response){"connected"===response.status&&FB.logout(function(logout_response){console.log("User logged out of Facebook with response:"),console.log(logout_response)})},!0)}function onMySignIn(googleUser){let profile=googleUser.getBasicProfile(),id_token=googleUser.getAuthResponse().id_token;$("#email_oauth").val(profile.getEmail()),$("#id_oauth").val(profile.getId()),$("#access_token_oauth").val(id_token),checkGoogleCallbackDataWithServer()}function triggerGoogleLogin(){let options=new gapi.auth2.SigninOptionsBuilder;options.setPrompt("select_account"),gapi.auth2.getAuthInstance().signIn(options).then(function(success){console.log("Google Login successful"),onMySignIn(gapi.auth2.getAuthInstance().currentUser.get())},function(error){console.log("Google Login failed"),console.log(error)})}function checkGoogleCallbackDataWithServer(){console.log("checkGoogleCallbackDataWithServer"),$id=$("#id_oauth").val(),$email=$("#email_oauth").val(),$locale=$("#locale_oauth").val();let $ajaxUrlCheckServerTokenAvailable=Routing.generate("catrobat_oauth_login_google_servertoken_available",{flavor:"pocketcode"});$.post($ajaxUrlCheckServerTokenAvailable,{id:$id},function(data){if(data.token_available)GoogleLogin(data.email,data.username,$id,$locale);else{$("#id_oauth").val($id),$("#email_oauth").val($email),$("#locale_oauth").val($locale);let $ajaxUrlCheckEmailAvailable=Routing.generate("catrobat_oauth_login_email_available",{flavor:"pocketcode"});$.post($ajaxUrlCheckEmailAvailable,{email:$email},function(data,status){!1===data.email_available?getDesiredUsernameGoogle():sendCodeToServer($("#access_token_oauth").val(),$id,data.username,$email,$locale)})}})}function getDesiredUsernameGoogle(){console.log("getDesiredUsernameGoogle"),$("#fb_google").val("g+"),openDialog()}function sendCodeToServer($id_token,$gplus_id,$username,$email,$locale){console.log("sendCodeToServer");let $ajaxUrl=Routing.generate("catrobat_oauth_login_google_code",{flavor:"pocketcode"});$.post($ajaxUrl,{id_token:$id_token,id:$gplus_id,username:$username,email:$email,locale:$locale},function(data,status){GoogleLogin($email,$username,$gplus_id,$locale)})}function GoogleLogin($email,$username,$id,$locale){console.log("GoogleLogin");let $ajaxUrl=Routing.generate("catrobat_oauth_login_google",{flavor:"pocketcode"});$.post($ajaxUrl,{username:$username,id:$id,email:$email,locale:$locale},function(data,status){let $ajaxLoginRedirectUrl=Routing.generate("catrobat_oauth_login_redirect",{flavor:"pocketcode"});$.post($ajaxLoginRedirectUrl,{gplus_id:$id},function(data,status){$url=data.url,$(location).attr("href",$url)})})}function GoogleLogout(){console.log("GoogleLogout");let $ajaxGetGoogleAppId=Routing.generate("catrobat_oauth_login_get_google_appid",{flavor:"pocketcode"});$.get($ajaxGetGoogleAppId,function(data){let sessionParams={client_id:data.gplus_appid,session_state:null};gapi.auth.checkSessionState(sessionParams,function(connected){connected&&gapi.auth.signOut()})})}function openDialog(){$("#dialog-oauth-username").dialog("open");let dark_background=$('<div id="bg-dark"></div>');dark_background.css({position:"fixed",width:"100%",height:"100%","background-color":"black",left:"0",top:"0",opacity:"0.5"}),$("body").append(dark_background)}$(document).ready(function(){$("#btn-logout").click(function(){GoogleLogout()}),$(document).on("click","#btn-login_google",function(){agree||$("#btn-google-modal-trigger").click(),agree_button="google_login"})}),$(document).ready(function(){if($("#btn_oauth_username").attr("disabled","disabled"),$("#dialog_oauth_username_input").on("input",function(e){$("#error_username_taken").css("display","none"),""!=$("#dialog_oauth_username_input").val().trim()?($("#btn_oauth_username").removeAttr("disabled"),$("#btn_oauth_username").css({opacity:1})):($("#btn_oauth_username").attr("disabled","disabled"),$("#btn_oauth_username").css({opacity:.5}))}),$("#dialog-oauth-username").on("dialogclose",function(event,ui){$("#bg-dark").remove()}),$("#btn_oauth_username").click(function(){let $ajaxUrl=Routing.generate("catrobat_oauth_login_username_available",{flavor:"pocketcode"});$.post($ajaxUrl,{username:$("#dialog_oauth_username_input").val()},function(data){1==data.username_available?$("#error_username_taken").css("display","block"):"fb"==$("#fb_google").val()?sendTokenToServer($("#access_token_oauth").val(),$("#id_oauth").val(),$("#dialog_oauth_username_input").val(),$("#email_oauth").val(),$("#locale_oauth").val()):"g+"==$("#fb_google").val()&&sendCodeToServer($("#access_token_oauth").val(),$("#id_oauth").val(),$("#dialog_oauth_username_input").val(),$("#email_oauth").val(),$("#locale_oauth").val())})}),""===$("#csrf_token_oauth").val()){let $ajaxUrl=Routing.generate("catrobat_oauth_register_get_csrftoken",{flavor:"pocketcode"});$.get($ajaxUrl,function(data){$("#csrf_token_oauth").val(data.csrf_token)})}}),$(function(){let $dialogSelector=$("#dialog-oauth-username");$dialogSelector.length&&$dialogSelector.dialog({autoOpen:!1})});